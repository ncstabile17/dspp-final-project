---
title: "DSPP Final Project"
author: "Nick Stabile"
date: "11/13/2020"
output: html_document
---
**Data Source:** [DC FY19 Economic Development Return on Investment Data spreadsheet](https://dmped.dc.gov/sites/default/files/dc/sites/dmped/publication/attachments/Return%20on%20Investment%20Data_FY15-19_v3.xlsx)

**Data Author:** Office of the Deputy Mayor for Planning and Economic Development (DMPED)

**Github Repo:** [DSPP Final Project](https://github.com/ncstabile17/dspp-final-project)

This data set pulls together economic development investments from across a variety of agencies and programs in the DC government for FY15-19. The data set was created by DMPED as required by the Economic Development Return on Investment Accountability Amendment Act of 2018. Fore more information see DMPED's [FY19 Economic Development Return on Investment Accountability Report](https://dmped.dc.gov/sites/default/files/dc/sites/dmped/publication/attachments/FY19%20ED%20Return%20on%20Investment%20Accountability%20Report.pdf).


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(readxl)
library(scales)
```

### Data Import and Cleaning
```{r warning = FALSE, message = FALSE, results = FALSE}

# Removing unneeded variables and making the variable names easier to work with 
dc_housing_investment <- read_csv("data/dc-housing-investment.csv") %>% 
  select(-`Is recipient in compliance with District resident employment requirements?`, 
         -`Amenity Produced or Enhanced`,
         -`Affordable Housing Compliance?  (Covenanted)`,
         -`CBE Compliant?`,
         -`Additional Incentive Benefits`,
         -`Notes`,
         -`Incentive Type`,
         -`Agency`) %>% 
  rename(
    year = `FY`,
    incentive_name = `Incentive Name`,
    recipient_name = `Recipient Name`,
    incentive_amount = `Incentive Amount`, 
    investment_address = `MAR Address of Investment`,
    ward = `MAR_Ward`,
    ami_30 = `30% AMI`,
    ami_50 = `50% AMI`,
    ami_60 = `60% AMI`,
    ami_80 = `80% AMI`,
    total_dmped_affordable = `Total Affordable Units Produced or Preserved`,
    dc_residents_employed = `Number of District Residents Employed`,
    num_cbes = `Number of CBEs`
    ) %>% 
  # Ensuring variables are consistent and converting to numeric
  # Note that the "HFA Revenue Bond Issuance" was renamed to "HFA Revenue Bond" in 2019 so this code makes all years consistent
  mutate(
    investment_address = str_to_upper(investment_address),
    ami_30 = as.numeric(ami_30),
    ami_50 = as.numeric(ami_50),
    ami_60 = as.numeric(ami_60),
    ami_80 = as.numeric(ami_80),
    total_dmped_affordable = as.numeric(total_dmped_affordable),
    incentive_name=replace(incentive_name, incentive_name=="HFA Revenue Bond Issuance", "HFA Revenue Bond")
  ) %>% 
  # Standardizing quadrant parts of address 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHEAST", 
    replacement = "NE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHEAST", 
    replacement = "SE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHWEST", 
    replacement = "NW"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHWEST", 
    replacement = "SW"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "STREET", 
    replacement = "ST"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "ROAD", 
    replacement = "RD"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "PLACE", 
    replacement = "PL"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "AVENUE", 
    replacement = "AVE"
    )

# Removing commas and periods from addresses for consistency
dc_housing_investment$investment_address <- str_remove_all(dc_housing_investment$investment_address, "[,.]")

```

```{r}

# Doing similar importing and cleaning for additional project data that has market rate unit data
affordable_proj_market_rate <- read_csv("data/affordable-projects-market-rate.csv") %>% 
  select(-`Projected or Actual Construction Completion Date`,
         -`External Project Website`,
         -`Project Type/Scope`) %>% 
  rename(
    investment_address = `Address`,
    total_units = `Total Units`,
    loan_grant_amount = `Loan/Grant Amount`,
    lihtc_amount = `LIHTC Allocation`,
    ami_0_30 = `0-30% AMI units`,
    ami_31_50 = `31-50% AMI Units`,
    ami_51_80 = `51-80% AMI Units`,
    ami_81 = `81%+ AMI / Market Rate`,
    total_dhcd_affordable = `Affordable Units`,
    psh_units = `PSH Units`
  ) %>%
  mutate(
    investment_address = str_to_upper(investment_address),
    market_rate_units = total_units - total_dhcd_affordable,
    total_units = as.numeric(total_units),
    loan_grant_amount = replace_na(as.numeric(gsub('[\\$,]', '', loan_grant_amount)), 0),
    lihtc_amount = replace_na(as.numeric(gsub('[\\$,]', '', lihtc_amount)), 0),
    total_investment = lihtc_amount + loan_grant_amount
  ) %>% 
  filter(!is.na(total_units)) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHEAST", 
    replacement = "NE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHEAST", 
    replacement = "SE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHWEST", 
    replacement = "NW"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHWEST", 
    replacement = "SW"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "STREET", 
    replacement = "ST"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "ROAD", 
    replacement = "RD"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "PLACE", 
    replacement = "PL"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "AVENUE", 
    replacement = "AVE"
    )

affordable_proj_market_rate$investment_address <- str_remove_all(affordable_proj_market_rate$investment_address, "[,.]")

```

```{r}

# Getting total investment data by project for both data sets

investment_by_project <- affordable_proj_market_rate %>% 
  group_by(investment_address) %>% 
  summarize(total_dhcd_investment = sum(total_investment))

affordable_proj_market_rate <- 
  left_join(affordable_proj_market_rate, investment_by_project, by = "investment_address")

affordable_proj_market_rate <- affordable_proj_market_rate %>% 
  distinct(investment_address, .keep_all= TRUE)

total_proj_data <- dc_housing_investment %>% 
  group_by(investment_address) %>% 
  summarize(total_dmped_investment = sum(incentive_amount))

dc_housing_investment <- 
  left_join(dc_housing_investment, total_proj_data, by = "investment_address")
```

```{r}

# Merging the existing data set with market rate data set and recoding some variables
# Since I will be doing project-level analysis rather than investment-level, I remove duplicate entries by address

# The investment and unit data from the two data sets do not always line up
# I compare the investment amount and take the larger of the values assuming that the data set with a larger investment value is more up to date with recent funding allocation
# I do the same with the affordable unit data 
# Before comparing, I replace missing values with 0 for the corresponding variables from the other data set  
# I also align the ami_30 data so all projects with data for 30% AMI units are using the ami_0_30 variable

combined_data <- 
  full_join(dc_housing_investment, affordable_proj_market_rate, by = "investment_address") %>% 
  distinct(investment_address, .keep_all= TRUE) %>% 
  mutate(total_dmped_investment = replace_na(total_dmped_investment, 0),
         total_dhcd_investment = replace_na(total_dhcd_investment, 0),
         total_dmped_affordable = replace_na(total_dmped_affordable, 0),
         total_dhcd_affordable = replace_na(total_dhcd_affordable, 0),
         total_proj_investment = if_else(total_dmped_investment > total_dhcd_investment, total_dmped_investment, total_dhcd_investment),
         total_proj_affordable = if_else(total_dmped_affordable > total_dhcd_affordable, total_dmped_affordable, total_dhcd_affordable),
         ami_0_30 = if_else((is.na(ami_0_30) & !is.na(ami_30)), ami_30, ami_0_30))


```

```{r}

# I want to plot the investment and total unit production
# For this, I exclude projects that did not produce any housing (N = 147), projects without investment data (N = 85), and those that produced affordable units, but did not have clear data on total units for the project (N = 30)

total_unit_investment_data <- combined_data %>% 
  filter(!is.na(total_units) & total_proj_investment > 0) %>% 
  mutate(investment_per_unit = total_proj_investment/total_units,
         investment_year = as.numeric(str_sub(`Projected or Actual Closing Date`, -2, -1)))

total_unit_investment_data %>% 
  ggplot(aes(x = total_proj_investment, 
        y = total_units)) +
  geom_point(
    aes(color = if_else(market_rate_units > 0, "Yes", "No"))) +
  geom_smooth(method=lm) +
  labs(title = "Total Investment by Affordable Units",
       color = "Project with Market Rate Units") +
  scale_x_continuous(labels = comma) +
  scale_color_manual(values = c("black", "red")) +
  theme_minimal()

total_unit_investment_data %>% 
  mutate(has_market_rate = if_else(market_rate_units > 0, TRUE, FALSE)) %>% 
  ggplot() +
  geom_histogram(
    aes(x = investment_per_unit),
    color="black", 
    fill="white",
    binwidth = 10000) +
  scale_x_continuous(labels = comma) +
  facet_wrap(~ has_market_rate)

total_unit_investment_data %>% 
  mutate(investment_year = if_else((is.na(investment_year) & !is.na(year)), as.numeric(str_sub(year, -2, -1)), investment_year)) %>% 
  ggplot() +
  geom_histogram(
    aes(x = investment_per_unit),
    color="black", 
    fill="white",
    binwidth = 10000) +
  scale_x_continuous(labels = comma) +
  facet_wrap(~ investment_year)

# Want to look at the investment per unit and relationship to number of affordable units produced
total_unit_investment_data %>% 
  ggplot(aes(x = investment_per_unit, 
        y = total_proj_affordable)) +
  geom_point() +
  geom_smooth(method=lm) +
  labs(title = "Total Investment by Affordable Units") +
  scale_x_continuous(labels = comma) +
  theme_minimal()

total_unit_investment_data %>% 
  ggplot(aes(x = investment_per_unit, 
        y = ami_0_30)) +
  geom_point() +
  geom_smooth(method=lm) +
  labs(title = "Total Investment by Affordable Units") +
  scale_x_continuous(labels = comma) +
  theme_minimal()

total_unit_investment_data %>% 
  ggplot(aes(x = investment_per_unit, 
        y = ami_81)) +
  geom_point() +
  geom_smooth(method=lm) +
  labs(title = "Total Investment by Affordable Units") +
  scale_x_continuous(labels = comma) +
  theme_minimal()
  

```

```{r}




```



```{r}
comparing_units <- combined_data %>% 
  mutate(total_dmped_affordable = replace_na(total_dmped_affordable, 0),
         total_dhcd_affordable = replace_na(total_dhcd_affordable, 0),
         more_units = if_else(total_dhcd_affordable > total_dmped_affordable, "DHCD", "DMPED"),
         unit_diff = total_dmped_affordable - total_dhcd_affordable,
         total_units = replace_na(total_units, 0)) %>% 
  filter(is.na(total_units))


         unit_cost = if_else(total_units > 0, total_proj_investment/total_units, 0),
         affordable_cost = if_else(total_proj_affordable > 0, total_proj_investment/total_proj_affordable, 0),
         ami_30_cost = if_else(ami_0_30 > 0, total_proj_investment/ami_30_ratio, 0)

comparing_investment <- combined_data %>% 
  mutate(total_dmped_investment = replace_na(total_dmped_investment, 0),
         total_dhcd_investment = replace_na(total_dhcd_investment, 0),
         bigger_investment = if_else(total_dhcd_investment > total_dmped_investment, "DHCD", "DMPED"),
         invest_diff = total_dmped_investment - total_dhcd_investment) %>% 
  select(investment_address, total_dmped_investment, total_dhcd_investment, invest_diff, bigger_investment)

```


```{r}

# trying to make a data set with projects/investment_address as unit of observation
# but also want to preserve each incentive_name that was used for each project

# I should just ask how to do this




```

```{r}



# The set of ratio variables show how much a particular investment (observation) contributed to the overall project to account for projects with multiple investments
# The second set of variables was created to analyze the return on investment in terms of number of dollars invested for each unit
dc_housing_investment <- dc_housing_investment %>% 
  mutate(
    investment_ratio = incentive_amount/total_proj_investment,
    total_affordable_ratio = investment_ratio*total_affordable,
    ami_30_ratio = investment_ratio*ami_30,
    ami_50_ratio = investment_ratio*ami_50,
    ami_60_ratio = investment_ratio*ami_60,
    ami_80_ratio = investment_ratio*ami_80,
    total_affordable_efficiency = if_else(total_affordable_ratio > 0, incentive_amount/total_affordable_ratio, 0),
    ami_30_efficiency = if_else(ami_30_ratio > 0, incentive_amount/ami_30_ratio, 0),
    ami_50_efficiency = if_else(ami_50_ratio > 0, incentive_amount/ami_50_ratio, 0),
    ami_60_efficiency = if_else(ami_60_ratio > 0, incentive_amount/ami_60_ratio, 0),
    ami_80_efficiency = if_else(ami_80_ratio > 0, incentive_amount/ami_80_ratio, 0),
    )

# Looking to pull in data on market rate housing units
```


