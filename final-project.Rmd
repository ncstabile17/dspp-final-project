---
title: "DSPP Final Project"
author: "Nick Stabile"
date: "11/13/2020"
output: html_document
---
**Data Source:** [DC FY19 Economic Development Return on Investment Data spreadsheet](https://dmped.dc.gov/sites/default/files/dc/sites/dmped/publication/attachments/Return%20on%20Investment%20Data_FY15-19_v3.xlsx)

**Data Author:** Office of the Deputy Mayor for Planning and Economic Development (DMPED)

**Github Repo:** [DSPP Assignment 04](https://github.com/ncstabile17/dspp-assignment04)

This data set pulls together economic development investments from across a variety of agencies and programs in the DC government for FY15-19. The data set was created by DMPED as required by the Economic Development Return on Investment Accountability Amendment Act of 2018. Fore more information see DMPED's [FY19 Economic Development Return on Investment Accountability Report](https://dmped.dc.gov/sites/default/files/dc/sites/dmped/publication/attachments/FY19%20ED%20Return%20on%20Investment%20Accountability%20Report.pdf).


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(readxl)
library(scales)
```

### Data Import and Cleaning
```{r warning = FALSE, message = FALSE, results = FALSE}

# Making the variable names easier to work with 
dc_housing_investment <- read_csv("data/dc-housing-investment.csv") %>% 
  rename(
    year = `FY`,
    incentive_name = `Incentive Name`,
    recipient_name = `Recipient Name`,
    incentive_amount = `Incentive Amount`, 
    investment_address = `MAR Address of Investment`,
    ward = `MAR_Ward`,
    ami_30 = `30% AMI`,
    ami_50 = `50% AMI`,
    ami_60 = `60% AMI`,
    ami_80 = `80% AMI`,
    total_affordable = `Total Affordable Units Produced or Preserved`,
    ) %>% 
  # Ensuring variables are consistent and converting to numeric
  # Note that the "HFA Revenue Bond Issuance" was renamed to "HFA Revenue Bond" in 2019 so this code makes all years consistent
  mutate(
    investment_address = str_to_upper(investment_address),
    ami_30 = as.numeric(ami_30),
    ami_50 = as.numeric(ami_50),
    ami_60 = as.numeric(ami_60),
    ami_80 = as.numeric(ami_80),
    total_affordable = as.numeric(total_affordable),
    incentive_name=replace(incentive_name, incentive_name=="HFA Revenue Bond Issuance", "HFA Revenue Bond")
  ) %>% 
  filter(!is.na(total_affordable)) %>% 
  # Standardizing quadrant parts of address 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHEAST", 
    replacement = "NE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHEAST", 
    replacement = "SE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHWEST", 
    replacement = "NW"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHWEST", 
    replacement = "SW"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "STREET", 
    replacement = "ST"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "ROAD", 
    replacement = "RD"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "PLACE", 
    replacement = "PL"
    )

dc_housing_investment$investment_address <- str_remove_all(dc_housing_investment$investment_address, "[,.]") 

affordable_proj_market_rate <- read_csv("data/affordable-projects-market-rate.csv") %>% 
  rename(
    investment_address = `Address`,
    total_units = `Total Units`
  ) %>%
  mutate(
    investment_address = str_to_upper(investment_address),
    total_units = as.numeric(total_units)
  ) %>% 
  filter(!is.na(total_units)) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHEAST", 
    replacement = "NE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHEAST", 
    replacement = "SE"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "NORTHWEST", 
    replacement = "NW"
    ) %>% 
  mutate_if(
    is.character, 
    str_replace_all, 
    pattern = "SOUTHWEST", 
    replacement = "SW"
    )

affordable_proj_market_rate$investment_address <- str_remove_all(affordable_proj_market_rate$investment_address, "[,.]")

```

```{r}

# trying to make a data set with projects/investment_address as unit of observation
# but also want to preserve each incentive_name that was used for each project

# I should just ask how to do this

total_proj_data <- dc_housing_investment %>% 
  group_by(investment_address) %>% 
  summarize(total_proj_investment = sum(incentive_amount))

dc_housing_investment <- 
  left_join(dc_housing_investment, total_proj_data, by = "investment_address")




```

```{r}
# I don't think this is actually doing to work because it looks like there are multiple 
# entrees for some addresses in the second data set
# Or it might work but might need additional maneuvering, might be easier to use MAR
# Also, it looks like there are some entries with affordable housing listed in the second
# data set, but not the first (particularly tax exemptions)
# Also, the second data set has investments prior to 2015, which makes things confusing
# if(nrow(anti_join(dc_housing_investment, affordable_proj_market_rate, by = "investment_address")) == 0){
#  print("Success - no data lost in join")
# } else {
#   print(paste0(
#    "Warning - ", nrow(anti_join(dc_housing_investment, affordable_proj_market_rate, by = "investment_address")),
#    " rows of data were not joined."))
# }

# dc_housing_investment <- left_join(dc_housing_investment, affordable_proj_market_rate, by = "investment_address")

# Some projects (denoted by address) had multiple investments from different programs so it's useful to know the total investment for each observation
# There is probably a more efficient way to add this variable 
total_proj_data <- dc_housing_investment %>% 
  group_by(investment_address) %>% 
  summarize(total_proj_investment = sum(incentive_amount))

dc_housing_investment <- 
  left_join(dc_housing_investment, total_proj_data, by = "investment_address")

# The set of ratio variables show how much a particular investment (observation) contributed to the overall project to account for projects with multiple investments
# The second set of variables was created to analyze the return on investment in terms of number of dollars invested for each unit
dc_housing_investment <- dc_housing_investment %>% 
  mutate(
    investment_ratio = incentive_amount/total_proj_investment,
    total_affordable_ratio = investment_ratio*total_affordable,
    ami_30_ratio = investment_ratio*ami_30,
    ami_50_ratio = investment_ratio*ami_50,
    ami_60_ratio = investment_ratio*ami_60,
    ami_80_ratio = investment_ratio*ami_80,
    total_affordable_efficiency = if_else(total_affordable_ratio > 0, incentive_amount/total_affordable_ratio, 0),
    ami_30_efficiency = if_else(ami_30_ratio > 0, incentive_amount/ami_30_ratio, 0),
    ami_50_efficiency = if_else(ami_50_ratio > 0, incentive_amount/ami_50_ratio, 0),
    ami_60_efficiency = if_else(ami_60_ratio > 0, incentive_amount/ami_60_ratio, 0),
    ami_80_efficiency = if_else(ami_80_ratio > 0, incentive_amount/ami_80_ratio, 0),
    )

# Looking to pull in data on market rate housing units
```


